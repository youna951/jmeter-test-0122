name: dev, smoke test - JMeter로 light한 부하테스트

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]
  workflow_dispatch: # Actions 탭에서 수동으로 '딸깍' 실행하기 위한 트리거

jobs:
  performance-test:
    runs-on: ubuntu-latest

    steps:
      # [1] 코드 체크아웃: 현재 레포지토리의 소스 코드를 가상 서버로 가져옴
      - name: Checkout code
        uses: actions/checkout@v4

      # [2] Node.js 설정: json-server를 돌리기 위한 환경 구축
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # [3] 가짜 API 서버(json-server) 기동
      # ⭐⭐⭐ &를 붙여 백그라운드 실행해야 다음 스텝으로 넘어감
      - name: Start Mock API Server
        run: |
          npm install -g json-server
          json-server --watch ./src/backend/db-pika.json --port 3333 &

      # [4] JMeter 최신 버전 다운로드 및 압축 해제
      # 리눅스 기본 패키지(apt)는 버전이 낮아 리포트 생성(-e) 옵션이 안 먹을 수 있음
      - name: Install Latest JMeter (v5.6.3)
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      # [5] JMeter CLI 실행 (양적 테스트 수행)
      # -n: 화면 없는 모드(CLI)
      # -t: 테스트 플랜 파일(.jmx) 지정
      # -l: 원시 결과 데이터 저장(.jtl)
      # -e -o: 테스트 종료 후 즉시 예쁜 HTML 리포트 생성
      - name: Run JMeter Performance Test
        run: |
          mkdir -p dashboard_report
          ./apache-jmeter-5.6.3/bin/jmeter -n -t ./json-server-test-plan.jmx -l ./result.jtl -e -o ./dashboard_report

      # [6] 생성된 HTML 리포트 업로드
      # if: always()는 테스트가 실패(Error %)해도 '왜 실패했는지' 리포트를 봐야 하므로 무조건 실행
      - name: Upload JMeter Report
        uses: actions/upload-artifact@v4
        if: always() 
        with:
          name: jmeter-performance-report
          path: dashboard_report/
